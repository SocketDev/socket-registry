name: üîó CI

# Comprehensive CI orchestrator that runs lint, type checks, and tests.
# Orchestrates multiple quality checks in parallel for efficient CI execution.
#
# Dependencies:
#   - SocketDev/socket-registry/.github/actions/setup-and-install
#   - SocketDev/socket-registry/.github/actions/run-script

on:
  workflow_call:
    inputs:
      debug:
        description: 'Enable debug output (e.g., "1" for verbose logging)'
        required: false
        type: string
        default: '0'
      fail-fast:
        description: 'Cancel all matrix jobs if one fails'
        required: false
        type: boolean
        default: false
      lint-node-version:
        description: 'Node.js version for linting'
        required: false
        type: string
        default: '22'
      lint-script:
        description: 'Lint command (e.g., "pnpm run lint --all")'
        required: false
        type: string
        default: 'pnpm run lint --all'
      lint-setup-script:
        description: 'Setup script before linting'
        required: false
        type: string
        default: ''
      lint-timeout-minutes:
        description: 'Timeout for lint job in minutes'
        required: false
        type: number
        default: 10
      max-parallel:
        description: 'Maximum parallel test jobs'
        required: false
        type: number
        default: 4
      node-versions:
        description: 'Node.js versions for testing (e.g., ''[20, 22, 24]'')'
        required: false
        type: string
        default: '[20, 22, 24]'
      os-versions:
        description: 'Operating systems for testing (e.g., ''["ubuntu-latest", "windows-latest"]'')'
        required: false
        type: string
        default: '["ubuntu-latest", "windows-latest"]'
      retention-days:
        description: 'Days to retain artifacts'
        required: false
        type: number
        default: 7
      run-lint:
        description: 'Include lint check job'
        required: false
        type: boolean
        default: true
      run-test:
        description: 'Include test matrix job'
        required: false
        type: boolean
        default: true
      run-type-check:
        description: 'Include type check job'
        required: false
        type: boolean
        default: true
      test-script:
        description: 'Test command (e.g., "pnpm run test --all")'
        required: false
        type: string
        default: 'pnpm run test --all'
      test-setup-script:
        description: 'Setup script before tests (e.g., "pnpm run build")'
        required: false
        type: string
        default: ''
      test-timeout-minutes:
        description: 'Timeout for test jobs in minutes'
        required: false
        type: number
        default: 15
      type-check-node-version:
        description: 'Node.js version for type checking'
        required: false
        type: string
        default: '22'
      type-check-script:
        description: 'Type check command (e.g., "pnpm run check")'
        required: false
        type: string
        default: 'pnpm run check'
      type-check-setup-script:
        description: 'Setup script before type checking'
        required: false
        type: string
        default: ''
      type-check-timeout-minutes:
        description: 'Timeout for type check job in minutes'
        required: false
        type: number
        default: 10
      working-directory:
        description: 'Working directory (e.g., "packages/core" for monorepos)'
        required: false
        type: string
        default: '.'

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  lint:
    if: inputs.run-lint
    name: üßπ Lint Check
    runs-on: ubuntu-latest
    timeout-minutes: ${{ inputs.lint-timeout-minutes }}
    steps:
      - uses: SocketDev/socket-registry/.github/actions/setup-and-install@4709a2443e5a036bb0cd94e5d1559f138f05994c # main
        with:
          debug: ${{ inputs.debug }}
          node-version: ${{ inputs.lint-node-version }}
          working-directory: ${{ inputs.working-directory }}

      - uses: SocketDev/socket-registry/.github/actions/run-script@4709a2443e5a036bb0cd94e5d1559f138f05994c # main
        with:
          main-script: ${{ inputs.lint-script }}
          setup-script: ${{ inputs.lint-setup-script }}
          working-directory: ${{ inputs.working-directory }}

  type-check:
    if: inputs.run-type-check
    name: üîç Type Check
    runs-on: ubuntu-latest
    timeout-minutes: ${{ inputs.type-check-timeout-minutes }}
    steps:
      - uses: SocketDev/socket-registry/.github/actions/setup-and-install@4709a2443e5a036bb0cd94e5d1559f138f05994c # main
        with:
          debug: ${{ inputs.debug }}
          node-version: ${{ inputs.type-check-node-version }}
          working-directory: ${{ inputs.working-directory }}

      - uses: SocketDev/socket-registry/.github/actions/run-script@4709a2443e5a036bb0cd94e5d1559f138f05994c # main
        with:
          main-script: ${{ inputs.type-check-script }}
          setup-script: ${{ inputs.type-check-setup-script }}
          working-directory: ${{ inputs.working-directory }}

  test:
    if: inputs.run-test
    name: üß™ Test Matrix
    strategy:
      fail-fast: ${{ inputs.fail-fast }}
      max-parallel: ${{ inputs.max-parallel }}
      matrix:
        node-version: ${{ fromJson(inputs.node-versions) }}
        os: ${{ fromJson(inputs.os-versions) }}
    runs-on: ${{ matrix.os }}
    timeout-minutes: ${{ inputs.test-timeout-minutes }}
    steps:
      - uses: SocketDev/socket-registry/.github/actions/setup-and-install@4709a2443e5a036bb0cd94e5d1559f138f05994c # main
        with:
          debug: ${{ inputs.debug }}
          node-version: ${{ matrix.node-version }}
          working-directory: ${{ inputs.working-directory }}

      - uses: SocketDev/socket-registry/.github/actions/run-script@4709a2443e5a036bb0cd94e5d1559f138f05994c # main
        with:
          main-script: ${{ inputs.test-script }}
          setup-script: ${{ inputs.test-setup-script }}
          working-directory: ${{ inputs.working-directory }}
