'use strict'

const fs = require('node:fs/promises')
const util = require('node:util')

const YAML = require('@zkochan/js-yaml')
const readYamlFile = require('read-yaml-file')

const constants = require('@socketregistry/scripts/constants')
const { ENV, parseArgsConfig, tapCiConfigPath, tapConfigPath } = constants
const { isModified } = require('@socketregistry/scripts/lib/git')

const { values: cliArgs } = util.parseArgs(parseArgsConfig)

void (async () => {
  // Exit early if no relevant files have been modified.
  if (!cliArgs.force && !ENV.CI && !(await isModified(tapConfigPath))) {
    return
  }
  const config = await readYamlFile(tapConfigPath)
  const content = `# This file is auto-generated by 'npm run update:tap-config'\n${YAML.dump(
    {
      ...config,
      passes: true,
      reporter: 'base'
    }
  )}`
  await fs.writeFile(tapCiConfigPath, content, 'utf8')
})()
