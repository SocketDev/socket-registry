'use strict'

const util = require('node:util')

const YAML = require('@zkochan/js-yaml')
const fs = require('fs-extra')
const readYamlFile = require('read-yaml-file')

const constants = require('@socketregistry/scripts/constants')
const { ciTapConfigPath, parseArgsConfig, rootTapConfigPath } = constants
const { isModified } = require('@socketregistry/scripts/utils/git')

const { values: cliArgs } = util.parseArgs(parseArgsConfig)

;(async () => {
  // Exit early if no relevant files have been modified.
  if (!cliArgs.force && !(await isModified(rootTapConfigPath))) {
    return
  }
  const { plugin, ...config } = await readYamlFile(rootTapConfigPath)
  const content = `# This file is auto-generated by 'npm run update:tap-config'\n${YAML.dump(
    {
      ...config,
      reporter: 'base',
      passes: true,
      plugin
    }
  )}`
  await fs.writeFile(ciTapConfigPath, content, 'utf8')
})()
